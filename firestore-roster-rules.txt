// Firestore Security Rules for Roster System
// Copy and paste these rules into your Firebase Console → Firestore Database → Rules

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to check if user is admin or manager
    function isAdminOrManager() {
      return isAuthenticated() && getUserRole() in ['admin', 'manager'];
    }
    
    // Roster rules
    match /rosters/{rosterId} {
      // Allow users to read their own roster entries
      // Allow admin/manager to read all roster entries
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdminOrManager());
      
      // Allow users to create their own roster entries
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.createdBy == request.auth.uid;
      
      // Allow users to update their own roster entries
      // Prevent changing userId and createdBy fields
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid &&
        request.resource.data.userId == resource.data.userId &&
        request.resource.data.createdBy == resource.data.createdBy;
      
      // Allow users to delete their own roster entries
      allow delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // Users collection (if not already defined)
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}

// IMPORTANT NOTES:
// 1. These rules assume you have a 'users' collection with a 'role' field
// 2. Valid roles are: 'admin', 'manager', 'employee'
// 3. Make sure to create Firestore composite indexes as documented
// 4. Test these rules thoroughly before deploying to production
// 5. Adjust rules based on your specific security requirements
